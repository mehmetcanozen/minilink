<!-- Enhanced Dashboard Header -->
<section class="dashboard-hero">
    <div class="container">
        <div class="dashboard-header">
            <div class="header-content">
                <h1 class="dashboard-title">
                    <span class="gradient-text">Analytics</span> Dashboard
                </h1>
                <p class="dashboard-subtitle">
                    Monitor your URL performance and track engagement metrics in real-time
                </p>
                <div class="dashboard-stats">
                    <div class="quick-stat">
                        <i class="fas fa-chart-line"></i>
                        <span>Real-time tracking</span>
                    </div>
                    <div class="quick-stat">
                        <i class="fas fa-clock"></i>
                        <span>24/7 monitoring</span>
                    </div>
                    <div class="quick-stat">
                        <i class="fas fa-shield-alt"></i>
                        <span>Secure data</span>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-outline enhanced" onclick="refreshAllData()">
                    <i class="fas fa-sync-alt"></i>
                    Refresh All
                </button>
            </div>
        </div>
    </div>
    
    <!-- Animated Background -->
    <div class="dashboard-bg">
        <div class="bg-shape shape-1"></div>
        <div class="bg-shape shape-2"></div>
        <div class="bg-shape shape-3"></div>
    </div>
</section>

<!-- Enhanced System Statistics -->
<section class="section-sm">
    <div class="container">
        <div class="stats-grid enhanced" id="systemStatsContainer">
            <div class="stat-card enhanced">
                <div class="stat-icon primary">
                    <i class="fas fa-link"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="totalUrls">
                        <div class="spinner-sm"></div>
                    </div>
                    <div class="stat-label">Total URLs</div>
                    <div class="stat-trend">
                        <i class="fas fa-arrow-up"></i>
                        <span>+12% this week</span>
                    </div>
                </div>
            </div>
            
            <div class="stat-card enhanced">
                <div class="stat-icon success">
                    <i class="fas fa-mouse-pointer"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="totalClicks">
                        <div class="spinner-sm"></div>
                    </div>
                    <div class="stat-label">Total Clicks</div>
                    <div class="stat-trend">
                        <i class="fas fa-arrow-up"></i>
                        <span>+8% this week</span>
                    </div>
                </div>
            </div>
            
            <div class="stat-card enhanced">
                <div class="stat-icon warning">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="avgClicksPerUrl">
                        <div class="spinner-sm"></div>
                    </div>
                    <div class="stat-label">Avg Clicks/URL</div>
                    <div class="stat-trend">
                        <i class="fas fa-arrow-up"></i>
                        <span>+5% this week</span>
                    </div>
                </div>
            </div>
            
            <div class="stat-card enhanced">
                <div class="stat-icon secondary">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="systemUptime">
                        <div class="spinner-sm"></div>
                    </div>
                    <div class="stat-label">System Uptime</div>
                    <div class="stat-trend">
                        <i class="fas fa-check-circle"></i>
                        <span>99.9%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Enhanced URL Analytics -->
<section class="section analytics-section">
    <div class="container">
        <div class="analytics-grid">
            <!-- Enhanced Popular URLs -->
            <div class="analytics-card">
                <div class="card-header enhanced">
                    <div class="header-content">
                        <div class="card-title">
                            <i class="fas fa-fire"></i>
                            Most Popular URLs
                        </div>
                        <div class="card-subtitle">Top performing links by click count</div>
                    </div>
                    <button class="btn btn-sm btn-outline enhanced" id="refreshPopularBtn">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="card-body enhanced">
                    <div id="popularUrlsContainer" class="urls-container">
                        <div class="loading-placeholder">
                            <div class="spinner"></div>
                            <div class="loading-text">Loading popular URLs...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Recent URLs -->
            <div class="analytics-card">
                <div class="card-header enhanced">
                    <div class="header-content">
                        <div class="card-title">
                            <i class="fas fa-clock"></i>
                            Recently Created URLs
                        </div>
                        <div class="card-subtitle">Latest shortened links</div>
                    </div>
                    <button class="btn btn-sm btn-outline enhanced" id="refreshRecentBtn">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="card-body enhanced">
                    <div id="recentUrlsContainer" class="urls-container">
                        <div class="loading-placeholder">
                            <div class="spinner"></div>
                            <div class="loading-text">Loading recent URLs...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Enhanced URL Lookup Section -->
<section class="section lookup-section">
    <div class="container">
        <div class="lookup-container">
            <div class="analytics-card enhanced">
                <div class="card-header enhanced">
                    <div class="header-content">
                        <div class="card-title">
                            <i class="fas fa-search"></i>
                            URL Lookup & Statistics
                        </div>
                        <div class="card-subtitle">Find detailed analytics for any short URL</div>
                    </div>
                </div>
                <div class="card-body enhanced">
                    <form id="urlLookupForm" class="lookup-form">
                        <div class="form-group">
                            <label for="slugInput" class="form-label">
                                <i class="fas fa-link"></i>
                                Enter short URL slug
                            </label>
                            <div class="input-group enhanced">
                                <div class="input-prefix">
                                    <%= baseUrl %>/
                                </div>
                                <input 
                                    type="text" 
                                    class="form-input enhanced" 
                                    id="slugInput"
                                    placeholder="your-short-slug"
                                    required
                                >
                                <button type="submit" class="btn btn-primary enhanced">
                                    <i class="fas fa-search"></i>
                                    Lookup
                                </button>
                            </div>
                        </div>
                    </form>

                    <!-- Enhanced URL Details -->
                    <div id="urlDetailsSection" class="url-details hidden">
                        <div class="details-card">
                            <div class="details-header">
                                <div class="details-icon">
                                    <i class="fas fa-chart-bar"></i>
                                </div>
                                <div class="details-info">
                                    <h3 class="details-title">URL Statistics</h3>
                                    <p class="details-subtitle">Comprehensive analytics for your link</p>
                                </div>
                            </div>
                            
                            <div class="details-content">
                                <div class="details-grid">
                                    <div class="detail-item">
                                        <div class="detail-label">Original URL</div>
                                        <div class="detail-value" id="originalUrlDisplay"></div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">Total Clicks</div>
                                        <div class="detail-value highlight" id="urlClickCount"></div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">Short URL</div>
                                        <div class="detail-value">
                                            <div class="url-display">
                                                <input type="text" id="shortUrlDisplay" readonly>
                                                <button class="copy-btn enhanced" id="copyUrlBtn">
                                                    <i class="fas fa-copy"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">Created Date</div>
                                        <div class="detail-value" id="urlCreatedDate"></div>
                                    </div>
                                </div>
                                
                                <div class="details-actions">
                                    <a href="#" class="btn btn-secondary enhanced" id="visitUrlBtn" target="_blank">
                                        <i class="fas fa-external-link-alt"></i>
                                        Visit URL
                                    </a>
                                    <button class="btn btn-outline enhanced" id="qrCodeBtn">
                                        <i class="fas fa-qrcode"></i>
                                        QR Code
                                    </button>
                                    <a href="#" class="btn btn-outline enhanced" id="viewStatsBtn">
                                        <i class="fas fa-chart-line"></i>
                                        View Stats
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Not Found Message -->
                    <div id="urlNotFoundSection" class="not-found hidden">
                        <div class="not-found-content">
                            <div class="not-found-icon">
                                <i class="fas fa-search"></i>
                            </div>
                            <h3 class="not-found-title">URL Not Found</h3>
                            <p class="not-found-message">
                                The requested short URL slug was not found in our database.
                            </p>
                            <div class="not-found-actions">
                                <button class="btn btn-outline" onclick="clearLookup()">
                                    <i class="fas fa-arrow-left"></i>
                                    Try Another
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Error Message -->
                    <div id="urlLookupError" class="lookup-error hidden">
                        <div class="error-content">
                            <div class="error-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <h3 class="error-title">Error</h3>
                            <p id="urlLookupErrorMessage" class="error-message"></p>
                            <button class="btn btn-outline" onclick="clearLookup()">
                                <i class="fas fa-redo"></i>
                                Try Again
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- QR Code Modal -->
<div class="modal" id="qrModal">
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="fas fa-qrcode"></i>
                QR Code
            </h3>
            <button class="modal-close" onclick="closeQRModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="qr-container">
                <div class="qr-code" id="qrCodeDisplay"></div>
                <p class="qr-text">Scan to access your shortened URL</p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="downloadQRCode()">
                <i class="fas fa-download"></i>
                Download QR Code
            </button>
            <button class="btn btn-outline" onclick="closeQRModal()">
                Close
            </button>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<script>
// Enhanced Dashboard JavaScript
class Dashboard {
    constructor() {
        this.initializeElements();
        this.bindEvents();
        this.loadInitialData();
        this.setupAnimations();
    }

    initializeElements() {
        this.popularContainer = document.getElementById('popularUrlsContainer');
        this.recentContainer = document.getElementById('recentUrlsContainer');
        this.refreshPopularBtn = document.getElementById('refreshPopularBtn');
        this.refreshRecentBtn = document.getElementById('refreshRecentBtn');
        this.lookupForm = document.getElementById('urlLookupForm');
        this.detailsSection = document.getElementById('urlDetailsSection');
        this.notFoundSection = document.getElementById('urlNotFoundSection');
        this.errorSection = document.getElementById('urlLookupError');
    }

    bindEvents() {
        this.refreshPopularBtn.addEventListener('click', () => this.loadPopularUrls());
        this.refreshRecentBtn.addEventListener('click', () => this.loadRecentUrls());
        this.lookupForm.addEventListener('submit', (e) => this.handleLookup(e));
        document.getElementById('copyUrlBtn').addEventListener('click', () => this.copyURL());
        document.getElementById('qrCodeBtn').addEventListener('click', () => this.showQRModal());
    }

    loadInitialData() {
        this.loadSystemStats();
        this.loadPopularUrls();
        this.loadRecentUrls();
    }

    async loadSystemStats() {
        try {
            const response = await fetch('/api/stats');
            const result = await response.json();
            
            if (result.success) {
                document.getElementById('totalUrls').textContent = result.data.totalUrls.toLocaleString();
                document.getElementById('totalClicks').textContent = result.data.totalClicks.toLocaleString();
                
                const avgClicks = result.data.totalUrls > 0 ? 
                    (result.data.totalClicks / result.data.totalUrls).toFixed(1) : '0';
                document.getElementById('avgClicksPerUrl').textContent = avgClicks;
                
                // Calculate uptime (mock data)
                const uptimeHours = Math.floor(Math.random() * 720) + 24;
                const uptimeDays = Math.floor(uptimeHours / 24);
                document.getElementById('systemUptime').textContent = `${uptimeDays}d ${uptimeHours % 24}h`;
                
                // Add animation to stats
                this.animateStats();
            }
        } catch (error) {
            console.error('Failed to load system stats:', error);
            this.showErrorInStats();
        }
    }

    animateStats() {
        const statCards = document.querySelectorAll('.stat-card.enhanced');
        statCards.forEach((card, index) => {
            setTimeout(() => {
                card.classList.add('animate-in');
            }, index * 100);
        });
    }

    showErrorInStats() {
        document.querySelectorAll('.stat-value .spinner-sm').forEach(spinner => {
            spinner.parentElement.innerHTML = '<span class="error-text">Error</span>';
        });
    }

    async loadPopularUrls() {
        this.showLoadingState(this.popularContainer);
        
        try {
            const response = await fetch('/api/urls/popular?limit=5');
            const result = await response.json();
            
            if (result.success && result.data.length > 0) {
                this.renderURLList(this.popularContainer, result.data, 'popular');
            } else {
                this.renderEmptyState(this.popularContainer, 'popular');
            }
        } catch (error) {
            this.renderErrorState(this.popularContainer);
        }
    }

    async loadRecentUrls() {
        this.showLoadingState(this.recentContainer);
        
        try {
            const response = await fetch('/api/urls/recent?limit=5');
            const result = await response.json();
            
            if (result.success && result.data.length > 0) {
                this.renderURLList(this.recentContainer, result.data, 'recent');
            } else {
                this.renderEmptyState(this.recentContainer, 'recent');
            }
        } catch (error) {
            this.renderErrorState(this.recentContainer);
        }
    }

    showLoadingState(container) {
        container.innerHTML = `
            <div class="loading-placeholder">
                <div class="spinner"></div>
                <div class="loading-text">Loading URLs...</div>
            </div>
        `;
    }

    renderURLList(container, urls, type) {
        const urlList = document.createElement('div');
        urlList.className = 'url-list enhanced fade-in';
        
        urls.forEach((url, index) => {
            const urlItem = this.createURLItem(url, type, index);
            urlList.appendChild(urlItem);
        });
        
        container.innerHTML = '';
        container.appendChild(urlList);
    }

    createURLItem(url, type, index) {
        const urlItem = document.createElement('div');
        urlItem.className = 'url-item enhanced';
        
        const rankBadge = type === 'popular' ? `
            <div class="rank-badge rank-${index + 1}">
                ${index + 1}
            </div>
        ` : '';
        
        urlItem.innerHTML = `
            <div class="url-main">
                ${rankBadge}
                <div class="url-info">
                    <div class="url-slug">/${url.shortSlug}</div>
                    <div class="url-original">${this.truncateUrl(url.originalUrl, 60)}</div>
                    ${url.expiresAt ? `
                        <div class="url-expiration">
                            <i class="fas fa-clock"></i>
                            Expires: ${new Date(url.expiresAt).toLocaleDateString()}
                        </div>
                    ` : ''}
                </div>
            </div>
            <div class="url-meta">
                <div class="click-info">
                    <span class="click-count">${url.clickCount}</span>
                    <span class="click-label">clicks</span>
                </div>
                ${type === 'recent' ? `
                    <span class="url-time">${this.formatRelativeTime(url.createdAt)}</span>
                ` : ''}
                <a href="/${url.shortSlug}/stats" class="btn btn-sm btn-outline enhanced">
                    <i class="fas fa-chart-line"></i>
                </a>
            </div>
        `;
        
        return urlItem;
    }

    renderEmptyState(container, type) {
        const icon = type === 'popular' ? 'fire' : 'clock';
        const title = type === 'popular' ? 'No Popular URLs' : 'No Recent URLs';
        const subtitle = type === 'popular' ? 'URLs with clicks will appear here' : 'Recently created URLs will appear here';
        
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="fas fa-${icon}"></i>
                </div>
                <h4 class="empty-title">${title}</h4>
                <p class="empty-subtitle">${subtitle}</p>
            </div>
        `;
    }

    renderErrorState(container) {
        container.innerHTML = `
            <div class="error-state">
                <div class="error-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h4 class="error-title">Unable to Load</h4>
                <p class="error-subtitle">Please try again later</p>
            </div>
        `;
    }

    async handleLookup(e) {
        e.preventDefault();
        const slug = document.getElementById('slugInput').value.trim();
        if (slug) {
            await this.lookupUrl(slug);
        }
    }

    async lookupUrl(slug) {
        this.hideAllLookupSections();
        
        try {
            const response = await fetch(`/api/urls/${slug}/stats`);
            const result = await response.json();
            
            if (response.ok && result.success) {
                this.showURLDetails(result.data);
            } else if (response.status === 404) {
                this.showNotFound();
            } else {
                throw new Error(result.error?.message || 'Failed to lookup URL');
            }
        } catch (error) {
            this.showLookupError(error.message);
        }
    }

    showURLDetails(data) {
        document.getElementById('originalUrlDisplay').textContent = data.originalUrl;
        document.getElementById('urlClickCount').textContent = data.clickCount;
        document.getElementById('shortUrlDisplay').value = `<%= baseUrl %>/${data.shortSlug}`;
        document.getElementById('urlCreatedDate').textContent = new Date(data.createdAt).toLocaleDateString();
        document.getElementById('visitUrlBtn').href = `<%= baseUrl %>/${data.shortSlug}`;
        document.getElementById('viewStatsBtn').href = `/${data.shortSlug}/stats`;
        
        this.detailsSection.classList.remove('hidden');
        this.detailsSection.classList.add('slide-in-up');
        
        this.showToast('URL found successfully!', 'success');
    }

    showNotFound() {
        this.notFoundSection.classList.remove('hidden');
        this.notFoundSection.classList.add('slide-in-up');
    }

    showLookupError(message) {
        document.getElementById('urlLookupErrorMessage').textContent = message;
        this.errorSection.classList.remove('hidden');
        this.errorSection.classList.add('slide-in-up');
        
        this.showToast(message, 'error');
    }

    hideAllLookupSections() {
        [this.detailsSection, this.notFoundSection, this.errorSection].forEach(section => {
            section.classList.add('hidden');
        });
    }

    async copyURL() {
        const input = document.getElementById('shortUrlDisplay');
        const button = document.getElementById('copyUrlBtn');
        
        try {
            await navigator.clipboard.writeText(input.value);
            button.innerHTML = '<i class="fas fa-check"></i>';
            button.classList.add('copy-success');
            
            setTimeout(() => {
                button.innerHTML = '<i class="fas fa-copy"></i>';
                button.classList.remove('copy-success');
            }, 2000);
            
            this.showToast('URL copied to clipboard!', 'success');
        } catch (err) {
            input.select();
            document.execCommand('copy');
            this.showToast('URL copied to clipboard!', 'success');
        }
    }

    showQRModal() {
        const shortUrl = document.getElementById('shortUrlDisplay').value;
        const qrCodeDisplay = document.getElementById('qrCodeDisplay');
        
        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(shortUrl)}`;
        qrCodeDisplay.innerHTML = `<img src="${qrUrl}" alt="QR Code" style="width: 100%; height: auto;">`;
        
        document.getElementById('qrModal').classList.add('show');
    }

    setupAnimations() {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('animate-in');
                }
            });
        }, { threshold: 0.1 });

        document.querySelectorAll('.analytics-card, .stat-card').forEach(el => {
            observer.observe(el);
        });
    }

    showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `
            <div class="toast-content">
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
                <span>${message}</span>
            </div>
        `;
        
        const container = document.getElementById('toastContainer');
        container.appendChild(toast);
        
        setTimeout(() => {
            toast.classList.add('fade-out');
            setTimeout(() => {
                container.removeChild(toast);
            }, 300);
        }, 3000);
    }

    truncateUrl(url, maxLength) {
        if (url.length <= maxLength) return url;
        return url.substring(0, maxLength - 3) + '...';
    }

    formatRelativeTime(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffInSeconds = Math.floor((now - date) / 1000);
        
        if (diffInSeconds < 60) return 'just now';
        if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
        if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
        return `${Math.floor(diffInSeconds / 86400)}d ago`;
    }
}

// Global functions
function refreshAllData() {
    const dashboard = window.dashboard;
    dashboard.loadSystemStats();
    dashboard.loadPopularUrls();
    dashboard.loadRecentUrls();
    dashboard.showToast('All data refreshed!', 'success');
}

function clearLookup() {
    document.getElementById('urlLookupForm').reset();
    document.getElementById('urlDetailsSection').classList.add('hidden');
    document.getElementById('urlNotFoundSection').classList.add('hidden');
    document.getElementById('urlLookupError').classList.add('hidden');
}

function closeQRModal() {
    document.getElementById('qrModal').classList.remove('show');
}

function downloadQRCode() {
    const shortUrl = document.getElementById('shortUrlDisplay').value;
    const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=400x400&data=${encodeURIComponent(shortUrl)}`;
    const link = document.createElement('a');
    link.download = 'qr-code.png';
    link.href = qrUrl;
    link.click();
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    window.dashboard = new Dashboard();
    
    // Make functions globally available
    window.refreshAllData = refreshAllData;
    window.clearLookup = clearLookup;
    window.closeQRModal = closeQRModal;
    window.downloadQRCode = downloadQRCode;
});
</script> 