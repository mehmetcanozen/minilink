<!-- URL Stats Header -->
<section class="bg-gradient-primary text-white py-5">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <div class="d-flex align-items-center mb-3">
                    <i class="fas fa-chart-line fa-2x me-3"></i>
                    <div>
                        <h1 class="display-6 fw-bold mb-1">URL Statistics</h1>
                        <p class="lead mb-0">Analytics for your short URL</p>
                    </div>
                </div>
                
                <!-- URL Info Card -->
                <div class="bg-white bg-opacity-10 rounded-3 p-4 mt-4">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h6 class="text-white-50 mb-2">Short URL</h6>
                            <div class="input-group">
                                <input type="text" class="form-control form-control-lg bg-white" 
                                       value="<%= shortUrl %>" id="shortUrlInput" readonly>
                                <button class="btn btn-light" type="button" id="copyMainBtn" title="Copy URL">
                                    <i class="fas fa-copy"></i>
                                </button>
                                <button class="btn btn-light" type="button" id="visitMainBtn" title="Visit URL">
                                    <a href="<%= shortUrl %>" target="_blank" class="text-decoration-none text-dark">
                                        <i class="fas fa-external-link-alt"></i>
                                    </a>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4 text-md-end mt-3 mt-md-0">
                            <div class="text-white-50 small mb-1">Total Clicks</div>
                            <div class="display-4 fw-bold"><%= urlStats.clickCount %></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 text-center">
                <!-- QR Code -->
                <div class="bg-white rounded-3 p-3 d-inline-block">
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=<%= encodeURIComponent(shortUrl) %>" 
                         alt="QR Code" class="img-fluid">
                </div>
                <div class="mt-2">
                    <button class="btn btn-light btn-sm" onclick="downloadQRCode()">
                        <i class="fas fa-download me-1"></i>Download QR
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Stats Details -->
<section class="py-5">
    <div class="container">
        <div class="row g-4">
            <!-- URL Details Card -->
            <div class="col-lg-8">
                <div class="card url-card h-100">
                    <div class="card-header bg-white border-0 py-3">
                        <h5 class="fw-bold mb-0">
                            <i class="fas fa-info-circle me-2 text-primary"></i>
                            URL Details
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        <!-- Original URL -->
                        <div class="mb-4">
                            <label class="fw-bold text-muted mb-2">Original URL</label>
                            <div class="p-3 bg-light rounded-3 border">
                                <div class="d-flex align-items-center">
                                    <div class="flex-grow-1 url-text">
                                        <a href="<%= urlStats.originalUrl %>" target="_blank" 
                                           class="text-decoration-none text-dark">
                                            <%= urlStats.originalUrl %>
                                            <i class="fas fa-external-link-alt ms-2 text-muted small"></i>
                                        </a>
                                    </div>
                                    <button class="btn btn-sm btn-outline-primary ms-3" 
                                            onclick="copyToClipboard('<%= urlStats.originalUrl %>')">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Stats Grid -->
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="bg-primary bg-opacity-10 rounded-3 p-3 text-center">
                                    <i class="fas fa-calendar-plus fa-2x text-primary mb-2"></i>
                                    <div class="fw-bold">Created</div>
                                    <div class="text-muted small" id="createdDate">
                                        <%= new Date(urlStats.createdAt).toLocaleString('en-US', {
                                            dateStyle: 'long',
                                            timeStyle: 'short'
                                        }) %>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="bg-success bg-opacity-10 rounded-3 p-3 text-center">
                                    <i class="fas fa-clock fa-2x text-success mb-2"></i>
                                    <div class="fw-bold">Last Click</div>
                                    <div class="text-muted small" id="updatedDate">
                                        <%= new Date(urlStats.updatedAt).toLocaleString('en-US', {
                                            dateStyle: 'long',
                                            timeStyle: 'short'
                                        }) %>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- URL ID (for developers) -->
                        <div class="mt-4">
                            <label class="fw-bold text-muted mb-2 small">URL ID (for API usage)</label>
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control font-monospace small bg-light" 
                                       value="<%= urlStats.id %>" readonly>
                                <button class="btn btn-outline-secondary" type="button" 
                                        onclick="copyToClipboard('<%= urlStats.id %>')">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="col-lg-4">
                <div class="card feature-card">
                    <div class="card-header bg-white border-0 py-3">
                        <h5 class="fw-bold mb-0">
                            <i class="fas fa-tools me-2 text-success"></i>
                            Quick Actions
                        </h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="shareUrl()">
                                <i class="fas fa-share me-2"></i>
                                Share URL
                            </button>
                            <button class="btn btn-info text-white" onclick="showQRModal()">
                                <i class="fas fa-qrcode me-2"></i>
                                View QR Code
                            </button>
                            <button class="btn btn-outline-secondary" onclick="refreshStats()">
                                <i class="fas fa-sync-alt me-2"></i>
                                Refresh Stats
                            </button>
                            <hr class="my-3">
                            <a href="/" class="btn btn-outline-primary">
                                <i class="fas fa-plus me-2"></i>
                                Create New URL
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Performance Insights -->
                <div class="card feature-card mt-4">
                    <div class="card-header bg-white border-0 py-3">
                        <h6 class="fw-bold mb-0">
                            <i class="fas fa-lightbulb me-2 text-warning"></i>
                            Insights
                        </h6>
                    </div>
                    <div class="card-body p-4">
                        <% 
                        const daysSinceCreated = Math.max(1, Math.floor((new Date() - new Date(urlStats.createdAt)) / (1000 * 60 * 60 * 24)));
                        const avgClicksPerDay = (urlStats.clickCount / daysSinceCreated).toFixed(1);
                        const progressWidth = Math.min(avgClicksPerDay * 10, 100);
                        %>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <small class="text-muted">Daily Average</small>
                                <span class="fw-bold"><%= avgClicksPerDay %> clicks</span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar" role="progressbar" style="width: 0%;" 
                                     data-width="<%= progressWidth %>"></div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <small class="text-muted">Link Age</small>
                                <span class="fw-bold">
                                    <%= daysSinceCreated %> <%= daysSinceCreated === 1 ? 'day' : 'days' %>
                                </span>
                            </div>
                        </div>

                        <% if (urlStats.clickCount === 0) { %>
                            <div class="alert alert-info py-2 px-3 small">
                                <i class="fas fa-info-circle me-1"></i>
                                No clicks yet. Share your URL to get started!
                            </div>
                        <% } else if (urlStats.clickCount >= 100) { %>
                            <div class="alert alert-success py-2 px-3 small">
                                <i class="fas fa-star me-1"></i>
                                This is a popular link! Great work.
                            </div>
                        <% } else if (urlStats.clickCount >= 10) { %>
                            <div class="alert alert-primary py-2 px-3 small">
                                <i class="fas fa-thumbs-up me-1"></i>
                                Good engagement. Keep sharing the link.
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- QR Code Modal -->
<div class="modal fade" id="qrModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-qrcode me-2"></i>QR Code for <%= slug %>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center p-4">
                <div class="bg-white border rounded p-4 d-inline-block mb-3">
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=<%= encodeURIComponent(shortUrl) %>" 
                         alt="QR Code" class="img-fluid" id="modalQRImage">
                </div>
                <div class="mb-3">
                    <p class="text-muted mb-2">Scan to access:</p>
                    <code class="bg-light p-2 rounded"><%= shortUrl %></code>
                </div>
                <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                    <button class="btn btn-primary" onclick="downloadQRCode()">
                        <i class="fas fa-download me-2"></i>Download
                    </button>
                    <button class="btn btn-outline-secondary" onclick="copyToClipboard('<%= shortUrl %>')">
                        <i class="fas fa-copy me-2"></i>Copy URL
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Page Scripts -->
<script>
// Copy to clipboard function
async function copyToClipboard(text) {
    try {
        await navigator.clipboard.writeText(text);
        showToast('Copied to clipboard!', 'success');
    } catch (err) {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showToast('Copied to clipboard!', 'success');
    }
}

// Share URL function
async function shareUrl() {
    const url = '<%= shortUrl %>';
    const title = 'Check out this link';
    
    if (navigator.share) {
        try {
            await navigator.share({
                title: title,
                text: 'Shortened URL created with MiniLink',
                url: url
            });
        } catch (err) {
            copyToClipboard(url);
        }
    } else {
        copyToClipboard(url);
    }
}

// Show QR modal
function showQRModal() {
    const modal = new bootstrap.Modal(document.getElementById('qrModal'));
    modal.show();
}

// Download QR code
function downloadQRCode() {
    const qrUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=400x400&data=<%= encodeURIComponent(shortUrl) %>';
    const link = document.createElement('a');
    link.download = 'qr-code-<%= slug %>.png';
    link.href = qrUrl;
    link.click();
}

// Refresh stats
function refreshStats() {
    location.reload();
}

// Copy main URL button
document.getElementById('copyMainBtn').addEventListener('click', function() {
    copyToClipboard('<%= shortUrl %>');
});

// Set progress bar width from data attribute
document.addEventListener('DOMContentLoaded', function() {
    const progressBar = document.querySelector('.progress-bar[data-width]');
    if (progressBar) {
        setTimeout(() => {
            const width = progressBar.getAttribute('data-width');
            progressBar.style.width = width + '%';
        }, 300); // Small delay for animation
    }
});

// Toast notification function
function showToast(message, type = 'success') {
    // Reuse the toast function from main.js
    if (typeof window.showToast === 'function') {
        window.showToast(message, type);
    } else {
        // Fallback alert
        alert(message);
    }
}
</script> 